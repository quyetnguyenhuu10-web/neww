/* Reset Vite default styles để không phá style của app */
:root {
  font-synthesis: none;
  text-rendering: optimizeLegibility;
  -webkit-font-smoothing: antialiased;
  -moz-osx-font-smoothing: grayscale;
}

/* FORCE: dùng đúng theme variables (SSOT) */
html, body, #root {
  height: 100% !important;
  width: 100% !important;
  margin: 0 !important;
  padding: 0 !important;
  overflow: hidden !important;
}

html {
  overflow: hidden !important;
}

body {
  background: var(--bg, #f5f1ea) !important;
  color: var(--text, #1c1a17) !important;
  overflow: hidden !important;
  width: 100vw !important;
  height: 100vh !important;
  margin: 0 !important;
  padding: 0 !important;
}

#root {
  background: var(--bg, #f5f1ea) !important;
  height: 100vh !important;
  width: 100vw !important;
  margin: 0 !important;
  padding: 0 !important;
  overflow: hidden !important;
  position: relative !important;
}

/* WritingPane: Reset paragraph styles và căn baseline */
.writingPane .lp-editor {
  white-space: pre-wrap;
  word-break: break-word;
  /* Vietnamese diacritics support - đảm bảo dấu sắc kết hợp đúng */
  text-rendering: optimizeLegibility !important;
  -webkit-font-smoothing: antialiased !important;
  -moz-osx-font-smoothing: grayscale !important;
  font-feature-settings: normal !important;
  font-variant-ligatures: normal !important;
  /* Quan trọng: đảm bảo Unicode normalization và IME composition */
  unicode-bidi: normal !important;
  direction: ltr !important;
  /* Đảm bảo font hỗ trợ Vietnamese diacritics */
  font-family: "Times New Roman", Times, Georgia, ui-serif, serif !important;
  /* Đảm bảo text bắt đầu từ dòng đầu tiên - không có padding/margin */
  margin: 0 !important;
  padding: 0 !important;
  /* Căn text để baseline chạm dòng đầu tiên */
  display: block !important;
  /* Đảm bảo có thể click vào bất kỳ đâu để soạn thảo */
  cursor: text !important;
  /* Đảm bảo đủ chiều cao để click vào tất cả dòng */
  min-height: 888px !important; /* 37 lines * 24px */
  
  /* ===== INK SYSTEM v2 - "BÚT BI MẢNH" ===== */
  /* Font weight - Làm mảnh chữ tối đa */
  font-weight: 200 !important;
  
  /* Text fill gradient - CHỈ 2 STOP, RẤT NHẸ (gần như không nhìn thấy, chỉ "cảm") */
  background: linear-gradient(
    to bottom,
    var(--ink-gradient-top, #3A3530) 0%,
    var(--ink-gradient-bottom, #45403A) 100%
  );
  -webkit-background-clip: text;
  background-clip: text;
  -webkit-text-fill-color: transparent;
  color: transparent; /* Fallback */
  
  /* Edge handling - GIẢM CỰC MẠNH, chỉ 1 layer, không outer feather */
  /* Neutral band: để anti-alias mặc định xử lý, không can thiệp thêm */
  text-shadow: 0 0 0.5px var(--ink-edge-blend, rgba(106, 99, 90, 0.28));
  
  /* Font smoothing - Tối ưu để chữ mịn, nhưng để anti-alias tự nhiên */
  -webkit-font-smoothing: antialiased !important;
  -moz-osx-font-smoothing: grayscale !important;
  text-rendering: optimizeLegibility !important;
  /* KHÔNG dùng -webkit-text-stroke để tránh làm phình nét */
  
  /* Caret color - blink được browser tự xử lý */
  caret-color: var(--caret-ink, rgba(90, 75, 55, 0.65));
  
  /* Note: caret-width (1.5px) không được hỗ trợ rộng rãi, 
     browser sẽ dùng width mặc định (~1-2px tùy font-size) */
}

.writingPane .lp-editor p {
  margin: 0 !important;
  padding: 0 !important;
  line-height: 24px !important;
  /* Đảm bảo diacritics render đúng trong paragraphs */
  text-rendering: optimizeLegibility !important;
  font-family: "Times New Roman", Times, Georgia, ui-serif, serif !important;
  /* Font weight - Làm mảnh chữ tối đa */
  font-weight: 200 !important;
  /* Đảm bảo paragraph bắt đầu từ dòng đầu tiên - không có spacing */
  margin-top: 0 !important;
  margin-bottom: 0 !important;
  padding-top: 0 !important;
  padding-bottom: 0 !important;
  /* Đảm bảo không có spacing giữa các dòng */
  display: block !important;
  /* Kế thừa ink gradient và edge blend từ parent */
  background: inherit;
  -webkit-background-clip: inherit;
  background-clip: inherit;
  -webkit-text-fill-color: inherit;
  color: inherit;
  text-shadow: inherit;
  /* Font smoothing */
  -webkit-font-smoothing: antialiased !important;
  -moz-osx-font-smoothing: grayscale !important;
  -webkit-text-stroke: inherit;
}

/* Đảm bảo paragraph đầu tiên không có margin-top */
.writingPane .lp-editor p:first-child {
  margin-top: 0 !important;
  padding-top: 0 !important;
}

/* Đảm bảo tất cả text nodes trong editor render diacritics đúng */
.writingPane .lp-editor * {
  text-rendering: optimizeLegibility !important;
  -webkit-font-smoothing: antialiased !important;
  -moz-osx-font-smoothing: grayscale !important;
  /* Kế thừa ink gradient và edge blend */
  background: inherit;
  -webkit-background-clip: inherit;
  background-clip: inherit;
  -webkit-text-fill-color: inherit;
  color: inherit;
  text-shadow: inherit;
}

/* Quan trọng: Đảm bảo IME composition hoạt động đúng cho Vietnamese */
.writingPane .lp-editor[contenteditable="true"] {
  ime-mode: active !important;
  -webkit-ime-mode: active !important;
}

/* Đảm bảo text nodes không bị transform hoặc scale làm lệch diacritics */
/* Markdown elements styles - Match chat panel styling */
.writingPane .lp-editor-h1 {
  margin: 1em 0 0.5em 0 !important;
  font-size: 1.5em !important;
  font-weight: bold !important;
  line-height: 24px !important;
  padding: 0 !important;
}

.writingPane .lp-editor-h2 {
  margin: 1em 0 0.5em 0 !important;
  font-size: 1.3em !important;
  font-weight: bold !important;
  line-height: 24px !important;
  padding: 0 !important;
}

.writingPane .lp-editor-h3 {
  margin: 0.8em 0 0.4em 0 !important;
  font-size: 1.1em !important;
  font-weight: bold !important;
  line-height: 24px !important;
  padding: 0 !important;
}

.writingPane .lp-editor-ul,
.writingPane .lp-editor-ol {
  margin: 0.8em 0 !important;
  padding-left: 1.5em !important;
  line-height: 24px !important;
}

.writingPane .lp-editor-listitem {
  margin: 0.3em 0 !important;
  padding: 0 !important;
  line-height: 24px !important;
}

.writingPane .lp-editor-quote {
  border-left: 3px solid rgba(0,0,0,0.2) !important;
  padding-left: 1em !important;
  margin: 0.8em 0 !important;
  font-style: italic !important;
  line-height: 24px !important;
}

/* Inline code (`code`) - padding nhẹ, không áp dụng cho block */
.writingPane .lp-editor code:not(.lp-editor-code) {
  font-family: 'SF Mono', 'Monaco', 'Inconsolata', 'Roboto Mono', 'Source Code Pro', 'Courier New', Courier, monospace !important;
  font-size: 0.875em !important;
  background: var(--code-bg, var(--bg-soft, rgba(0, 0, 0, 0.05))) !important;
  padding: 2px 4px !important;
  border-radius: 3px !important;
  line-height: inherit !important;
}

/* Block code (```) - match chat panel. CodeNode = <code class="lp-editor-code" data-language="..."> */
.writingPane .lp-editor pre.lp-editor-code,
.writingPane .lp-editor .lp-editor-code[data-language],
.writingPane .lp-editor code.lp-editor-code {
  display: block !important;
  margin: 1em 0 !important;
  padding: 12px 14px !important;
  border-radius: 8px !important;
  max-width: 100% !important;
  border: 1px solid rgba(0, 0, 0, 0.1) !important;
  background: var(--code-bg, rgba(0, 0, 0, 0.04)) !important;
  color: var(--paper-text, rgba(0, 0, 0, 0.86)) !important;
  font-family: 'SF Mono', 'Monaco', 'Inconsolata', 'Roboto Mono', 'Source Code Pro', 'Courier New', Courier, monospace !important;
  font-size: 0.875rem !important;
  line-height: 1.55 !important;
  white-space: pre-wrap !important;
  word-break: break-word !important;
  overflow-wrap: break-word !important;
  -webkit-text-fill-color: unset !important;
  background-clip: unset !important;
  text-shadow: none !important;
}

:root[data-theme="dark"] .writingPane .lp-editor pre.lp-editor-code,
:root[data-theme="dark"] .writingPane .lp-editor .lp-editor-code[data-language],
:root[data-theme="dark"] .writingPane .lp-editor code.lp-editor-code {
  border-color: rgba(255, 255, 255, 0.1) !important;
  background: var(--code-bg, #141210) !important;
  color: var(--paper-text, #ECE6DD) !important;
}

.writingPane .lp-editor-hr {
  margin: 12px 0 !important;
  padding: 0 !important;
  border: none !important;
  border-top: 1px solid var(--muted-2, rgba(160, 150, 140, 0.3)) !important;
  height: 0 !important;
  line-height: 24px !important;
}

.writingPane .lp-editor-link {
  color: rgba(0, 102, 204, 0.8) !important;
  text-decoration: underline !important;
  cursor: pointer !important;
}

/* Table styles - Match chat panel */
.writingPane .lp-editor-table {
  border-collapse: collapse !important;
  width: 100% !important;
  margin: 0.8em 0 !important;
  border: 1px solid rgba(0,0,0,0.1) !important;
}

.writingPane .lp-editor-tableRow {
  /* Table row styling */
}

.writingPane .lp-editor-tableCell {
  border: 1px solid rgba(0,0,0,0.1) !important;
  padding: 8px !important;
  line-height: 24px !important;
}

.writingPane .lp-editor-tableCell[data-header="true"] {
  background: rgba(0,0,0,0.05) !important;
  font-weight: bold !important;
}

.writingPane .lp-editor,
.writingPane .lp-editor * {
  transform: none !important;
  text-transform: none !important;
  letter-spacing: normal !important;
}

/* ==========================================================================
   PAPER PATCHES — "DA GIẤY", "NHỊP ĐỌC", "LÕI NỘI DUNG",
   "DẤU HIỆU SỐNG", "DIVIDER MỀM", "ĐÚNG KIỂU WORD"
   ========================================================================== */

/* PATCH 4 — "ĐÚNG KIỂU WORD" (KHÔNG PHÂN DÒNG) */

/* PATCH A — Page geometry (quan trọng nhất) */
.writingPane .paper {
  padding-inline: 0 !important;  /* Không có padding - header/footer chạm mép */
  padding-block-start: 0 !important;   /* Header (thứ/ngày tháng) chạm mép trên giấy */
  padding-block-end: 64px !important;
}

.writingPane .paper-content {
  width: 100%;
  max-width: none;
}

/* Header (thứ/ngày tháng) sát mép giấy – full width, padding tối thiểu 8px */
.writingPane .paper .pageHeader {
  width: 100% !important;
  margin: 0 !important;
  padding-left: 8px !important;
  padding-right: 8px !important;
  position: relative;
  box-sizing: border-box;
}

/* Body: điều chỉnh lề trong phạm vi cả chiều ngang paper */
.writingPane .paper .pageBody {
  padding-inline: clamp(48px, 6vw, 72px) !important;
  box-sizing: border-box;
}

/* Đường ngắt trang mỗi 35 dòng (840px) — chuyển trang mới khi không đủ không gian */
.writingPane .paper .pageBody.pageBody--withBreaks {
  --page-break-line: rgba(0, 0, 0, 0.06);
  background-image: repeating-linear-gradient(
    to bottom,
    transparent 0,
    transparent 839px,
    var(--page-break-line) 839px,
    var(--page-break-line) 840px
  );
  background-position: 0 0;
}

:root[data-theme="dark"] .writingPane .paper .pageBody.pageBody--withBreaks {
  --page-break-line: rgba(255, 255, 255, 0.08);
}

/* Text area fill vùng body (trừ lề), không thêm inset cố định; nền trong suốt để thấy đường ngắt trang */
.writingPane .paper .pageBody .textArea {
  left: 0 !important;
  right: 0 !important;
  background: transparent !important;
}

/* PATCH B — Line rhythm (không ai thấy nhưng ai cũng cảm) */
.writingPane .paper .lp-editor {
  font-size: 16px !important;
  line-height: 1.7 !important;
  letter-spacing: 0.01em !important;
}

/* Override letter-spacing cho tất cả elements (từ normal → 0.01em) */
.writingPane .paper .lp-editor * {
  letter-spacing: 0.01em !important;
}

/* PATCH C — Paragraph spacing vô hình (override PATCH 2) */
.writingPane .paper .lp-editor p {
  margin: 0 0 0.5em 0 !important;
  margin-top: 0 !important;
  margin-bottom: 0.5em !important;
  line-height: 1.7 !important; /* Override từ 24px */
}

.writingPane .paper .lp-editor p:last-child {
  margin-bottom: 0 !important;
}

/* Text Alignment (căn lề trái/phải/giữa/đều) */
.writingPane .paper .lp-editor p[data-align="left"],
.writingPane .paper .lp-editor p[style*="text-align: left"] {
  text-align: left !important;
}

.writingPane .paper .lp-editor p[data-align="right"],
.writingPane .paper .lp-editor p[style*="text-align: right"] {
  text-align: right !important;
}

.writingPane .paper .lp-editor p[data-align="center"],
.writingPane .paper .lp-editor p[style*="text-align: center"] {
  text-align: center !important;
}

.writingPane .paper .lp-editor p[data-align="justify"],
.writingPane .paper .lp-editor p[style*="text-align: justify"] {
  text-align: justify !important;
}

/* LaTeX Block — ElementNode, frame+inner, paper palette */
.writingPane .paper .lp-editor .latexBlock {
  display: inline-block !important;
  width: fit-content !important;
  max-width: 100% !important;
  user-select: all;
  cursor: default;
  margin: 0.5em 0;
  position: relative;
}

.writingPane .paper .lp-editor .latexFrame {
  background: var(--paper-tint, rgba(255,255,255,0.55));
  border: 1px solid var(--paper-edge, rgba(28,26,23,0.10));
  border-radius: 10px;
  box-shadow: 0 1px 2px rgba(0,0,0,0.04);
  padding: 10px 12px;
  min-height: 2em;
  display: inline-block;
  width: fit-content;
}

.writingPane .paper .lp-editor .latexInner {
  text-align: left;
  overflow-x: auto;
  color: var(--latex-color);
  -webkit-font-smoothing: subpixel-antialiased;
  -moz-osx-font-smoothing: auto;
  text-rendering: geometricPrecision;
  font-weight: 500 !important; /* Đảm bảo base weight đậm */
}

.writingPane .paper .lp-editor .latexInner .MathJax,
.writingPane .paper .lp-editor .latexInner .MathJax *,
.writingPane .paper .lp-editor .latexInner math,
.writingPane .paper .lp-editor .latexInner math *,
.writingPane .paper .lp-editor .latexInner mjx-container,
.writingPane .paper .lp-editor .latexInner mjx-container *,
.writingPane .paper .lp-editor .latexInner mjx-math,
.writingPane .paper .lp-editor .latexInner mjx-svg {
  margin: 0 !important;
  text-align: left !important;
  display: inline-block !important;
  color: inherit !important;
  font-family: "STIX Two Math", "STIX Two Text", "STIXGeneral", "Latin Modern Math", "Computer Modern", serif !important;
  -webkit-font-smoothing: subpixel-antialiased !important;
  -moz-osx-font-smoothing: auto !important;
  text-rendering: geometricPrecision !important;
  opacity: 1 !important;
}

/* MathJax SVG trong block LaTeX — override ink gradient */
.writingPane .paper .lp-editor .latexInner,
.writingPane .paper .lp-editor .latexInner *,
.writingPane .paper .lp-editor .latexInner .latex-katex-output,
.writingPane .paper .lp-editor .latexInner .latex-katex-output * {
  color: var(--latex-color) !important;
  -webkit-text-fill-color: var(--latex-color) !important;
  background: none !important;
  background-clip: unset !important;
  -webkit-background-clip: unset !important;
  text-shadow: none !important;
}

/* MathJax trong .latexInner .latex-mjax-output */
.writingPane .paper .lp-editor .latexInner .latex-mjax-output mjx-container,
.writingPane .paper .lp-editor .latexInner .latex-mjax-output mjx-container *,
.writingPane .paper .lp-editor .latexInner .latex-mjax-output mjx-math,
.writingPane .paper .lp-editor .latexInner .latex-mjax-output mjx-svg {
  display: block !important;
  overflow: visible !important;
  visibility: visible !important;
  opacity: 1 !important;
  font-family: "STIX Two Math", "STIX Two Text", "STIXGeneral", "Latin Modern Math", "Computer Modern", serif !important;
}

.writingPane .paper .lp-editor .latexInner .latex-mjax-output mjx-svg,
.writingPane .paper .lp-editor .latexInner .latex-mjax-output mjx-svg text,
.writingPane .paper .lp-editor .latexInner .latex-mjax-output mjx-svg g,
.writingPane .paper .lp-editor .latexInner .latex-mjax-output mjx-svg path {
  fill: var(--latex-color) !important;
  stroke: none !important;
  font-family: "STIX Two Math" !important;
}

.writingPane .paper .lp-editor .latexInner mjx-container {
  display: inline-block !important;
}

.writingPane .paper .lp-editor .latexInner mjx-svg,
.writingPane .paper .lp-editor .latexInner mjx-svg text,
.writingPane .paper .lp-editor .latexInner mjx-svg g,
.writingPane .paper .lp-editor .latexInner mjx-svg path {
  fill: var(--latex-color) !important;
  stroke: none !important;
  font-family: "STIX Two Math" !important;
}

/* MathML elements trong block LaTeX dùng STIX Two - đảm bảo đậm */
.writingPane .paper .lp-editor .latexInner math,
.writingPane .paper .lp-editor .latexInner mrow,
.writingPane .paper .lp-editor .latexInner mi,
.writingPane .paper .lp-editor .latexInner mn,
.writingPane .paper .lp-editor .latexInner mtext,
.writingPane .paper .lp-editor .latexInner msup,
.writingPane .paper .lp-editor .latexInner msub,
.writingPane .paper .lp-editor .latexInner mfrac {
  font-family: "STIX Two Math", "STIX Two Text", "STIXGeneral", "Latin Modern Math", "Computer Modern", serif !important;
  color: inherit !important;
  font-weight: 500 !important;
}

/* Operators (mo) trong block LaTeX - đậm hơn */
.writingPane .paper .lp-editor .latexInner mo {
  font-family: "STIX Two Math", "STIX Two Text", "STIXGeneral", "Latin Modern Math", "Computer Modern", serif !important;
  color: inherit !important;
  font-weight: 600 !important; /* Đậm hơn cho operators */
  font-size: 1em !important;
}

/* Fraction bars trong block LaTeX */
.writingPane .paper .lp-editor .latexInner mfrac > mo {
  font-weight: 700 !important; /* Rất đậm cho fraction bar */
  border-top: 0.08em solid currentColor !important; /* Thêm border để đậm hơn */
}

.writingPane .paper .lp-editor .latexInner.lp-latex-error {
  font-family: ui-monospace, monospace;
  color: var(--muted-2);
}

/* LaTeX Line — ElementNode, inline với text (không chiếm full dòng) */
.writingPane .paper .lp-editor .latexLineHost {
  /* QUAN TRỌNG: inline-block để có thể hiển thị và có kích thước */
  display: inline-block;
  cursor: default;
  user-select: all;
  margin: 0;
  padding: 0;
  position: relative; /* QUAN TRỌNG: để dấu X hiển thị đúng vị trí */
  vertical-align: baseline; /* Align với text baseline */
  min-width: 20px; /* Đảm bảo có kích thước tối thiểu */
  min-height: 1em; /* Đảm bảo có chiều cao */
}

/* Dấu X xóa LaTeX: chỉ chữ ×, không khung tròn. Màu theo dark/light. */
/* LaTeX dùng màu chữ giống code block */
:root {
  --latex-delete-color: var(--text, #1c1a17);
  --latex-color: var(--paper-text, rgba(0, 0, 0, 0.86));
}
:root[data-theme="dark"] {
  --latex-delete-color: var(--text, #e8e4dc);
  --latex-color: var(--paper-text, #ECE6DD);
}

.writingPane .paper .lp-editor .latexLineHost .latex-delete-btn {
  position: absolute !important;
  top: -6px !important;
  right: -2px !important;
  width: auto !important;
  height: auto !important;
  padding: 0 !important;
  border: none !important;
  border-radius: 0 !important;
  background: none !important;
  color: var(--latex-delete-color) !important;
  display: none !important;
  align-items: center !important;
  justify-content: center !important;
  cursor: pointer !important;
  font-size: 1.1em !important;
  line-height: 1 !important;
  z-index: 1000 !important;
  user-select: none !important;
  pointer-events: auto !important;
  opacity: 0.75;
  transition: opacity 0.15s;
}

.writingPane .paper .lp-editor .latexLineHost:hover .latex-delete-btn {
  display: flex !important;
}

.writingPane .paper .lp-editor .latexLineHost .latex-delete-btn:hover {
  opacity: 1 !important;
}

/* Dấu X cho LaTeX Block — cùng style */
.writingPane .paper .lp-editor .latexBlock .latex-delete-btn {
  position: absolute;
  top: -6px;
  right: -2px;
  width: auto;
  height: auto;
  padding: 0;
  border: none;
  border-radius: 0;
  background: none;
  color: var(--latex-delete-color);
  display: none;
  align-items: center;
  justify-content: center;
  cursor: pointer;
  font-size: 1.1em;
  line-height: 1;
  z-index: 1000;
  user-select: none;
  opacity: 0.75;
  transition: opacity 0.15s;
}

.writingPane .paper .lp-editor .latexBlock:hover .latex-delete-btn {
  display: flex;
}

.writingPane .paper .lp-editor .latexBlock .latex-delete-btn:hover {
  opacity: 1;
}

/* Khối vuông đóng kín bọc LaTeX và spaces - dùng màu code block */
.writingPane .paper .lp-editor .latex-block-container {
  display: inline-block;
  position: relative;
  vertical-align: baseline;
  /* Dùng background và border giống code block */
  border: 1px solid rgba(0, 0, 0, 0.1);
  border-radius: 4px;
  background: var(--code-bg, rgba(0, 0, 0, 0.04));
  padding: 2px 4px;
  margin: 0;
  /* Vừa vặn với nội dung */
  width: fit-content;
  min-width: fit-content;
  box-sizing: border-box;
}

/* Dark mode cho LaTeX container */
:root[data-theme="dark"] .writingPane .paper .lp-editor .latex-block-container {
  border-color: rgba(255, 255, 255, 0.1) !important;
  background: var(--code-bg, #141210) !important;
}

/* Đồ thị hàm số (GraphNode) – cửa sổ thu gọn, di chuyển tự do */
.writingPane .paper .lp-editor .graph-block-wrap {
  display: block;
  position: relative;
  margin: 0.5em 0;
  padding: 8px;
  border-radius: 6px;
  border: 1px solid rgba(0, 0, 0, 0.1);
  background: var(--code-bg, rgba(0, 0, 0, 0.04));
  max-width: 100%;
  box-sizing: border-box;
}

.writingPane .paper .lp-editor .graph-block-wrap.graph-window-root {
  margin: 0;
  padding: 0;
  border: none;
  background: transparent;
  min-height: 4px;
}

/* Portal container cho cửa sổ đồ thị nổi */
#graph-windows-portal {
  position: fixed;
  top: 0;
  left: 0;
  width: 100vw;
  height: 100vh;
  pointer-events: none;
  z-index: 99998;
  overflow: visible;
}

/* Cửa sổ đồ thị - UI chính thống, di chuyển khắp màn hình */
.graph-window[data-graph-window],
.writingPane .paper .lp-editor .graph-window {
  border-radius: 8px;
  overflow: hidden;
  cursor: default;
  border: 1px solid rgba(0, 0, 0, 0.1);
  background: var(--code-bg, rgba(0, 0, 0, 0.04));
  position: fixed !important;
  z-index: 99999 !important;
  pointer-events: auto !important;
  isolation: isolate;
  /* Cho phép di chuyển ra ngoài viewport */
  will-change: transform;
  /* Đảm bảo không bị clip bởi parent */
  contain: layout style paint;
}

/* Header cửa sổ đồ thị */
.graph-window[data-graph-window] .graph-window-header,
.writingPane .paper .lp-editor .graph-window .graph-window-header {
  display: flex;
  align-items: center;
  gap: 8px;
  padding: 6px 10px;
  background: rgba(0, 0, 0, 0.06);
  border-bottom: 1px solid rgba(0, 0, 0, 0.08);
  cursor: grab;
  user-select: none;
  -webkit-user-select: none;
  -moz-user-select: none;
  -ms-user-select: none;
}

.graph-window[data-graph-window] .graph-window-drag,
.writingPane .paper .lp-editor .graph-window .graph-window-drag {
  flex-shrink: 0;
  font-size: 12px;
  color: rgba(0, 0, 0, 0.4);
  cursor: grab;
  user-select: none;
}

.graph-window[data-graph-window] .graph-window-title,
.writingPane .paper .lp-editor .graph-window .graph-window-title {
  flex: 1;
  min-width: 0;
  font-size: 0.95em;
  overflow: hidden;
  text-overflow: ellipsis;
  white-space: nowrap;
  user-select: none;
}

.graph-window[data-graph-window] .graph-window-title .katex,
.writingPane .paper .lp-editor .graph-window .graph-window-title .katex {
  font-size: 0.95em !important;
}

.graph-window[data-graph-window] .graph-window-collapse,
.writingPane .paper .lp-editor .graph-window .graph-window-collapse {
  flex-shrink: 0;
  width: 24px;
  height: 24px;
  padding: 0;
  border: none;
  border-radius: 4px;
  background: transparent;
  font-size: 10px;
  cursor: pointer;
  color: rgba(0, 0, 0, 0.6);
  display: flex;
  align-items: center;
  justify-content: center;
  user-select: none;
  transition: background 0.15s ease;
}

.graph-window[data-graph-window] .graph-window-collapse:hover,
.writingPane .paper .lp-editor .graph-window .graph-window-collapse:hover {
  background: rgba(0, 0, 0, 0.08);
}

.graph-window[data-graph-window] .graph-window-body,
.writingPane .paper .lp-editor .graph-window .graph-window-body {
  padding: 8px 10px 10px;
  background: inherit;
}

:root[data-theme="dark"] .graph-window[data-graph-window],
:root[data-theme="dark"] .writingPane .paper .lp-editor .graph-window {
  border-color: rgba(255, 255, 255, 0.1);
  background: var(--code-bg, #141210);
}

:root[data-theme="dark"] .graph-window[data-graph-window] .graph-window-header,
:root[data-theme="dark"] .writingPane .paper .lp-editor .graph-window .graph-window-header {
  border-color: rgba(255, 255, 255, 0.1);
  background: rgba(255, 255, 255, 0.06);
}

:root[data-theme="dark"] .graph-window[data-graph-window] .graph-window-drag,
:root[data-theme="dark"] .writingPane .paper .lp-editor .graph-window .graph-window-drag {
  color: rgba(255, 255, 255, 0.4);
}

:root[data-theme="dark"] .graph-window[data-graph-window] .graph-window-collapse,
:root[data-theme="dark"] .writingPane .paper .lp-editor .graph-window .graph-window-collapse {
  color: rgba(255, 255, 255, 0.6);
}

:root[data-theme="dark"] .graph-window[data-graph-window] .graph-window-collapse:hover,
:root[data-theme="dark"] .writingPane .paper .lp-editor .graph-window .graph-window-collapse:hover {
  background: rgba(255, 255, 255, 0.1);
}

:root[data-theme="dark"] .graph-window[data-graph-window] .graph-window-body,
:root[data-theme="dark"] .writingPane .paper .lp-editor .graph-window .graph-window-body {
  background: inherit;
}

.writingPane .paper .lp-editor .graph-block-equation {
  margin-bottom: 6px;
  font-size: 1em;
  min-height: 1.5em;
}

.writingPane .paper .lp-editor .graph-block-equation,
.writingPane .paper .lp-editor .graph-block-equation *,
.writingPane .paper .lp-editor .graph-block-equation .katex,
.writingPane .paper .lp-editor .graph-block-equation .katex * {
  color: var(--latex-color) !important;
  -webkit-text-fill-color: var(--latex-color) !important;
  background: none !important;
  background-clip: unset !important;
  -webkit-background-clip: unset !important;
  text-shadow: none !important;
}

.writingPane .paper .lp-editor .graph-block-equation .katex {
  font-size: 1em !important;
}

.writingPane .paper .lp-editor .graph-block-canvas {
  display: block;
  max-width: 100%;
  height: auto;
  border-radius: 4px;
}

.writingPane .paper .lp-editor .graph-block-wrap .graph-delete-btn {
  top: 4px;
  right: 4px;
}

.writingPane .paper .lp-editor .graph-window .graph-window-header .graph-delete-btn {
  position: relative;
  top: auto;
  right: auto;
  flex-shrink: 0;
  margin-left: auto;
}

/* Wrapper container tạo khối vuông đóng kín */
.writingPane .paper .lp-editor .latex-block-wrapper {
  display: inline-block !important;
  position: relative;
  vertical-align: baseline;
  /* Khối vuông đóng kín: border, background, padding */
  border: 1px solid rgba(59, 130, 246, 0.5) !important;
  border-radius: 4px;
  background: rgba(59, 130, 246, 0.05);
  padding: 2px;
  margin: 0;
  /* Vừa vặn với nội dung */
  width: fit-content;
  min-width: fit-content;
  box-sizing: border-box;
  /* Đảm bảo nội dung bên trong được align đúng */
  line-height: 1.7;
}

.writingPane .paper .lp-editor .latexLine {
  display: inline-block;
  font-size: 16px;
  line-height: 1.7;
  color: var(--latex-color);
  margin: 0;
  padding: 2px 4px;
  vertical-align: baseline;
  width: fit-content;
  max-width: 100%;
  background: transparent;
  border-radius: 0;
  border: none;
  box-shadow: none;
}

/* Khi LaTeX không nằm trong container, dùng màu code block */
.writingPane .paper .lp-editor .latexLineHost:not(.latex-block-container) .latexLine {
  border-radius: 4px;
  border: 1px solid rgba(0, 0, 0, 0.1);
  background: var(--code-bg, rgba(0, 0, 0, 0.04));
  padding: 2px 4px;
}

:root[data-theme="dark"] .writingPane .paper .lp-editor .latexLineHost:not(.latex-block-container) .latexLine {
  border-color: rgba(255, 255, 255, 0.1) !important;
  background: var(--code-bg, #141210) !important;
}

/* QUAN TRỌNG: Override ink gradient (color: transparent) — công thức phải dùng màu rõ */
.writingPane .paper .lp-editor .latexLineHost,
.writingPane .paper .lp-editor .latexLine,
.writingPane .paper .lp-editor .latexLineInner,
.writingPane .paper .lp-editor .latexLineInner *,
.writingPane .paper .lp-editor .latexLineInner .latex-katex-output,
.writingPane .paper .lp-editor .latexLineInner .latex-katex-output * {
  color: var(--latex-color) !important;
  -webkit-text-fill-color: var(--latex-color) !important;
  background: none !important;
  background-clip: unset !important;
  -webkit-background-clip: unset !important;
  text-shadow: none !important;
}

.writingPane .paper .lp-editor .latexLineInner {
  display: inline-block !important;
  vertical-align: baseline;
  -webkit-font-smoothing: subpixel-antialiased;
  -moz-osx-font-smoothing: auto;
  text-rendering: geometricPrecision;
  font-weight: 500 !important;
  min-width: 20px !important;
  min-height: 1em !important;
  visibility: visible !important;
  opacity: 1 !important;
  font-size: 1em !important;
}

.writingPane .paper .lp-editor .latex-raw-fallback {
  display: inline-block !important;
  visibility: visible !important;
  opacity: 1 !important;
  margin-right: 0.25em;
}

.writingPane .paper .lp-editor .latex-raw-fallback.latex-raw-hidden {
  display: none !important;
  visibility: hidden !important;
  opacity: 0 !important;
  margin-right: 0 !important;
}

.writingPane .paper .lp-editor .latex-katex-output {
  display: inline-block !important;
  vertical-align: baseline;
  color: var(--latex-color) !important;
  -webkit-text-fill-color: var(--latex-color) !important;
  background: none !important;
  background-clip: unset !important;
  -webkit-background-clip: unset !important;
  text-shadow: none !important;
}

/* KaTeX output - QUAN TRỌNG: override ink gradient */
.writingPane .paper .lp-editor .latex-katex-output,
.writingPane .paper .lp-editor .latex-katex-output *,
.writingPane .paper .lp-editor .latex-katex-output .katex,
.writingPane .paper .lp-editor .latex-katex-output .katex * {
  color: var(--latex-color) !important;
  -webkit-text-fill-color: var(--latex-color) !important;
  background: none !important;
  background-clip: unset !important;
  -webkit-background-clip: unset !important;
  text-shadow: none !important;
}

/* KaTeX elements - đảm bảo hiển thị */
.writingPane .paper .lp-editor .latex-katex-output .katex {
  display: inline-block !important;
  vertical-align: baseline !important;
  font-size: 1em !important;
  line-height: 1.2 !important;
}

.writingPane .paper .lp-editor .latex-katex-output .katex-display {
  display: block !important;
  margin: 0.5em 0 !important;
}

.writingPane .paper .lp-editor .latexBlock .latex-raw-fallback {
  display: block !important;
  margin-right: 0;
  margin-bottom: 0.25em;
}

.writingPane .paper .lp-editor .latexBlock .latex-katex-output {
  display: block !important;
}

.writingPane .paper .lp-editor .latexBlock .latex-katex-output .katex {
  display: block !important;
}

/* MathJax SVG render với STIX Two font - giải quyết vấn đề chữ mờ */
.writingPane .paper .lp-editor .latexLineInner .MathJax,
.writingPane .paper .lp-editor .latexLineInner .MathJax *,
.writingPane .paper .lp-editor .latexLineInner math,
.writingPane .paper .lp-editor .latexLineInner math *,
.writingPane .paper .lp-editor .latexLineInner mjx-container,
.writingPane .paper .lp-editor .latexLineInner mjx-container *,
.writingPane .paper .lp-editor .latexLineInner mjx-math,
.writingPane .paper .lp-editor .latexLineInner mjx-svg {
  color: inherit !important;
  font-family: "STIX Two Math", "STIX Two Text", "STIXGeneral", "Latin Modern Math", "Computer Modern", serif !important;
  -webkit-font-smoothing: subpixel-antialiased !important;
  -moz-osx-font-smoothing: auto !important;
  text-rendering: geometricPrecision !important;
  opacity: 1 !important;
}

/* MathJax SVG elements - đảm bảo hiển thị */
.writingPane .paper .lp-editor .latexLineInner mjx-container {
  display: inline-block !important;
  vertical-align: baseline !important;
  overflow: visible !important;
  visibility: visible !important;
}

.writingPane .paper .lp-editor .latexLineInner mjx-svg {
  display: inline-block !important;
  overflow: visible !important;
}

/* SVG fill phải dùng màu rõ — currentColor là transparent do ink gradient */
.writingPane .paper .lp-editor .latexLineInner mjx-svg,
.writingPane .paper .lp-editor .latexLineInner mjx-svg text,
.writingPane .paper .lp-editor .latexLineInner mjx-svg g,
.writingPane .paper .lp-editor .latexLineInner mjx-svg path {
  fill: var(--latex-color) !important;
  stroke: none !important;
  font-family: "STIX Two Math" !important;
}

/* MathML elements dùng STIX Two - đảm bảo đậm */
.writingPane .paper .lp-editor .latexLineInner math,
.writingPane .paper .lp-editor .latexLineInner mrow,
.writingPane .paper .lp-editor .latexLineInner mi,
.writingPane .paper .lp-editor .latexLineInner mn,
.writingPane .paper .lp-editor .latexLineInner mtext,
.writingPane .paper .lp-editor .latexLineInner msup,
.writingPane .paper .lp-editor .latexLineInner msub,
.writingPane .paper .lp-editor .latexLineInner mfrac {
  font-family: "STIX Two Math", "STIX Two Text", "STIXGeneral", "Latin Modern Math", "Computer Modern", serif !important;
  color: inherit !important;
  font-weight: 500 !important;
}

/* Operators (mo) - dấu =, +, -, /, v.v. - cần đậm hơn */
.writingPane .paper .lp-editor .latexLineInner mo {
  font-family: "STIX Two Math", "STIX Two Text", "STIXGeneral", "Latin Modern Math", "Computer Modern", serif !important;
  color: inherit !important;
  font-weight: 600 !important; /* Đậm hơn cho operators */
  font-size: 1em !important;
}

/* Fraction bars và operators trong fractions */
.writingPane .paper .lp-editor .latexLineInner mfrac > mo {
  font-weight: 700 !important; /* Rất đậm cho fraction bar */
  border-top: 0.08em solid currentColor !important; /* Thêm border để đậm hơn */
}

/* No focus outline; selection ring is enough */
.writingPane .paper .lp-editor .latexLine[data-lexical-decorator="true"],
.writingPane .paper .lp-editor .latexLine:focus,
.writingPane .paper .lp-editor .latexLineHost:focus-within {
  outline: none;
}

/* Optional: when Lexical node is selected, show a very soft ring */
.writingPane .paper .lp-editor .latexLineHost.lexical-block-selected .latexLine,
.writingPane .paper .lp-editor .latexLineHost[data-lexical-selected="true"] .latexLine {
  box-shadow: 0 0 0 2px var(--accent-ring, rgba(59, 130, 246, 0.3));
  border-radius: 8px;
}

/* Lớp đệm cho khối giả text (space nodes) trước/sau LaTeX */
/* Sử dụng CSS variable để có thể điều chỉnh padding */
:root {
  --latex-surrogate-padding: 8px; /* Có thể điều chỉnh được - padding chống chạm mép dòng */
}

/* Text node ngay sau LaTeX - thêm padding bên phải (chống chạm mép phải) */
.writingPane .paper .lp-editor p > .latexLineHost + span[data-lexical-text="true"],
.writingPane .paper .lp-editor p > .latexLineHost + * {
  padding-right: var(--latex-surrogate-padding, 8px) !important;
  min-width: var(--latex-surrogate-padding, 8px) !important; /* Đảm bảo có vùng click */
  display: inline-block !important; /* Để padding hoạt động */
  position: relative;
  cursor: text !important; /* Cursor text để có thể click và đặt cursor */
  user-select: text !important; /* Cho phép select và click */
}

/* Text node ngay trước LaTeX - thêm padding bên trái (chống chạm mép trái) */
/* Sử dụng class được thêm bởi LatexSurrogatePaddingPlugin */
.writingPane .paper .lp-editor p > span.latex-surrogate-before {
  padding-left: var(--latex-surrogate-padding, 8px) !important;
  min-width: var(--latex-surrogate-padding, 8px) !important;
  display: inline-block !important;
  position: relative;
  cursor: text !important;
  user-select: text !important;
}

/* Text node ngay sau LaTeX - sử dụng class được thêm bởi LatexSurrogatePaddingPlugin */
.writingPane .paper .lp-editor p > span.latex-surrogate-after {
  padding-right: var(--latex-surrogate-padding, 8px) !important;
  min-width: var(--latex-surrogate-padding, 8px) !important;
  display: inline-block !important;
  position: relative;
  cursor: text !important;
  user-select: text !important;
}

/* Spaces nằm trong khối container - style để tạo khối vuông đóng kín */
.writingPane .paper .lp-editor p > span.latex-surrogate-before + .latex-block-container,
.writingPane .paper .lp-editor p > .latex-block-container + span.latex-surrogate-after {
  /* Spaces và LaTeX cùng nằm trong một khối */
}

/* Khi LaTeX nằm trong container, spaces trước và sau cũng nằm trong container */
.writingPane .paper .lp-editor p > span.latex-surrogate-before:has(+ .latex-block-container),
.writingPane .paper .lp-editor p > .latex-block-container:has(+ span.latex-surrogate-after) {
  /* Đảm bảo spaces và LaTeX cùng nằm trong một khối */
}

/* Spacer paragraph: nhìn như 1 dòng trống nhưng vẫn có caret */
.writingPane .paper .lp-editor .spacerParagraph {
  margin: 0;
  padding: 0;
  min-height: 1.7em;     /* match line-height cảm giác text */
  min-width: 1px;       /* đảm bảo luôn focusable/clickable */
  line-height: 1.7;
  position: relative;
  user-select: text;    /* cursor có thể đứng, không bị chặn */
  
  /* DEBUG: Làm đậm và highlight để kiểm tra spacer có tồn tại */
  background-color: rgba(255, 0, 0, 0.1) !important; /* Màu đỏ nhạt */
  border: 1px dashed rgba(255, 0, 0, 0.3) !important; /* Viền đỏ đứt nét */
  font-weight: bold !important; /* Làm đậm text */
  color: red !important; /* Màu đỏ để dễ thấy */
  font-size: 14px !important;
  
  /* QUAN TRỌNG: Đảm bảo cursor luôn hiển thị - KHÔNG dùng color: transparent */
  caret-color: red !important; /* Cursor màu đỏ để dễ thấy */
  outline: none;
}

/* Đảm bảo text node trong spacer có thể nhận cursor */
.writingPane .paper .lp-editor .spacerParagraph > * {
  display: inline;
  color: red !important; /* DEBUG: màu đỏ để thấy */
  /* KHÔNG dùng opacity: 0 hoặc visibility: hidden vì sẽ ẩn cursor */
}

/* Không hiển thị dấu chấm/placeholder gì */
.writingPane .paper .lp-editor .spacerParagraph:empty::before {
  content: "";
}

/* Đảm bảo cursor hiển thị trong spacer (có ZWSP) */
.writingPane .paper .lp-editor .spacerParagraph[data-spacer="true"] {
  /* Force cursor visibility */
  caret-color: var(--paper-text, #000);
}

/* PATCH D — Ink contrast mềm hơn (đã có var(--paper-text) trong ink system) */
/* Color đã được set qua var(--paper-text) trong ink gradient system */

/* PATCH E — Paper surface sống hơn: đã điều chỉnh trong PaperCard.jsx
   - radial-gradient lệch từ 50% 30% → 48% 28%, ellipse 65% 45%
   - linear-gradient lệch từ 135deg → 140deg, stop từ 30%/60% → 28%/58%
*/

/* PATCH 1 — "DA GIẤY" (micro texture, thay grid line). Noise: SVG feTurbulence;
   có thể đổi sang url("/noise-very-subtle.png") khi có asset. */
.writingPane .paper::after {
  content: "";
  position: absolute;
  inset: 0;
  pointer-events: none;
  z-index: 1;
  border-radius: 14px;
  background-image:
    radial-gradient(
      120% 90% at 52% 28%,
      rgba(255, 255, 255, 0.06),
      rgba(255, 255, 255, 0) 60%
    ),
    url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='128' height='128'%3E%3Cfilter id='n'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.85' numOctaves='4' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23n)' opacity='0.5'/%3E%3C/svg%3E");
  opacity: 0.35;
  mix-blend-mode: overlay;
}

/* PATCH 2 — "NHỊP ĐỌC" (semantic rhythm) - BỊ OVERRIDE bởi PATCH C */
/* PATCH C (ĐÚNG KIỂU WORD) override paragraph spacing → margin: 0 0 0.5em 0 */

.writingPane .paper .lp-editor h1,
.writingPane .paper .lp-editor h2,
.writingPane .paper .lp-editor h3 {
  margin-block: 0.6em 0.5em !important;
}

.writingPane .paper .lp-editor h2,
.writingPane .paper .lp-editor-h2 {
  margin-top: 2.2em !important;
  margin-bottom: 0.6em !important;
}

.writingPane .paper .lp-editor h3,
.writingPane .paper .lp-editor-h3 {
  margin-top: 1.6em !important;
  margin-bottom: 0.4em !important;
}

/* PATCH 3 — "KHỐI Ý MỜ" - ĐÃ XÓA (user yêu cầu xóa background dòng) */

/* PATCH 4 — "LÕI NỘI DUNG" (max-width, mép thở) - BỊ OVERRIDE bởi PATCH A */
/* PATCH A (ĐÚNG KIỂU WORD) dùng .paper-content max-width: 720px thay vì 92% */

/* PATCH 5 — "DẤU HIỆU SỐNG" (selection & caret) */
.writingPane .paper .lp-editor::selection,
.writingPane .paper .lp-editor *::selection {
  background: var(--selection-bg, var(--selection-bg-ink, rgba(210, 195, 165, 0.22))) !important;
  box-shadow: inset 0 0 0 1px var(--selection-edge-ink, rgba(150, 120, 80, 0.18));
}

.writingPane .paper .lp-editor .caret {
  opacity: 0.85;
}

/* PATCH 6 — "DIVIDER MỀM" (thay HR cứng) */
.writingPane .paper .lp-editor hr,
.writingPane .paper .lp-editor .lp-editor-hr {
  border: none !important;
  height: 1px !important;
  background: linear-gradient(
    to right,
    transparent,
    var(--muted-2, rgba(160, 150, 140, 0.3)),
    transparent
  ) !important;
  opacity: 0.25 !important;
  margin: 2em 0 !important;
}

/* Line numbers - đã xóa (không còn dùng grid line và line numbers) */

/* Nhãn nhỏ phân biệt panel Opera vs Chat – dùng theme variables (tự đổi theo dark/light) */
.panelLabel {
  flex: 0 0 auto;
  padding: 6px 12px;
  font-size: 11px;
  font-weight: 600;
  letter-spacing: 0.06em;
  text-transform: uppercase;
  color: var(--muted);
  background: var(--bg-soft);
  border-bottom: 1px solid var(--border);
  user-select: none;
}
